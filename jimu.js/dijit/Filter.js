// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:jimu/dijit/templates/Filter.html":'\x3cdiv\x3e\r\n\t\x3cdiv data-dojo-attach-point\x3d"contentSection" class\x3d"content-section"\x3e\r\n\t\t\x3cdiv class\x3d"add-btn-section"\x3e\r\n\t\t\t\x3cdiv data-dojo-attach-point\x3d"btnAddExp" data-dojo-attach-event\x3d"click:_onBtnAddExpClick"\r\n\t\t\t class\x3d"add-with-icon jimu-state-disabled add-expression jimu-float-leading"\x3e\r\n\t\t\t\t\x3cspan data-dojo-attach-point\x3d"iconAddExp" class\x3d"jimu-icon jimu-icon-add jimu-state-disabled"\x3e\x3c/span\x3e\r\n\t\t\t\t\x3cspan class\x3d"add-label"\x3e${nls.addAnotherExpression}\x3c/span\x3e\r\n\t\t\t\x3c/div\x3e\r\n\t\t\t\x3cdiv data-dojo-attach-point\x3d"btnAddSet" data-dojo-attach-event\x3d"click:_onBtnAddSetClick"\r\n\t\t\t class\x3d"add-with-icon jimu-state-disabled add-set jimu-float-leading"\x3e\r\n\t\t\t\t\x3cspan data-dojo-attach-point\x3d"iconAddSet" class\x3d"jimu-icon jimu-icon-add jimu-state-disabled"\x3e\x3c/span\x3e\r\n\t\t\t\t\x3cspan class\x3d"add-label"\x3e${nls.addSet}\x3c/span\x3e\r\n\t\t\t\x3c/div\x3e\r\n\t\t\x3c/div\x3e\r\n\t\t\x3cspan data-dojo-attach-point\x3d"matchMsg" style\x3d"margin-top:11px;margin-bottom:11px;display:none;"\x3e\r\n\t\t\t\x3cspan\x3e${nls.strMatchMsgPart1}\x3c/span\x3e\r\n\t\t\t\x3cselect data-dojo-attach-point\x3d"allAnySelect"\x3e\r\n\t\t\t\t\x3coption value\x3d"AND" selected\x3e${nls.all}\x3c/option\x3e\r\n\t\t\t\t\x3coption value\x3d"OR"\x3e${nls.any}\x3c/option\x3e\r\n\t\t\t\x3c/select\x3e\r\n\t\t\t\x3cspan\x3e${nls.strMatchMsgPart2}\x3c/span\x3e\r\n\t\t\x3c/span\x3e\r\n\t\t\x3cdiv class\x3d"allExpsBox" data-dojo-attach-point\x3d"allExpsBox"\x3e\r\n\t\t\x3c/div\x3e\r\n\t\x3c/div\x3e\r\n\t\x3cdiv data-dojo-attach-point\x3d"errorSection" style\x3d"display:none;"\x3e\r\n\t\t\x3cspan class\x3d"jimu-icon jimu-icon-error"\x3e\x3c/span\x3e\r\n\t\t\x3cspan data-dojo-attach-point\x3d"errorTip" class\x3d"error-tip"\x3e\x3c/span\x3e\r\n\t\x3c/div\x3e\r\n\t\x3cdiv data-dojo-attach-point\x3d"noFilterTipSection" class\x3d"no-filter-tip" style\x3d"display:none;"\x3e\x3c/div\x3e\r\n\t\x3cdiv data-dojo-attach-point\x3d"loading" data-dojo-type\x3d"jimu/dijit/LoadingIndicator" data-dojo-props\x3d"hidden:true"\x3e\x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/Evented dojo/_base/declare dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/text!./templates/Filter.html jimu/filterUtils jimu/utils jimu/LayerInfos/LayerInfos jimu/dijit/_filter/ValueProviderFactory dijit/registry dojo/_base/lang dojo/_base/html dojo/_base/array dojo/aspect dojo/Deferred esri/request ./_SingleFilter ./_FilterSet ./LoadingIndicator".split(" "),function(n,p,q,r,t,u,v,w,x,y,z,d,e,f,k,h,l,A,B){return p([q,r,t,v,n],{templateString:u,baseClass:"jimu-filter",
declaredClass:"jimu.dijit.Filter",nls:null,_validOptions:!1,_layerDefinition:null,_def:null,valueProviderFactory:null,featureLayerId:null,layerInfosObj:null,noFilterTip:"",enableAskForValues:!1,postMixInProperties:function(){this.nls=window.jimuNls.filterBuilder;var a=this.nls.matchMsg.split("${any_or_all}");this.nls.strMatchMsgPart1=a[0]||"";this.nls.strMatchMsgPart2=a[1]||"";this.layerInfosObj=x.getInstanceSync();this.inherited(arguments)},postCreate:function(){this.inherited(arguments);this.noFilterTip&&
"string"===typeof this.noFilterTip&&(this.noFilterTipSection.innerHTML=this.noFilterTip)},reset:function(){this.isBuilding()||(this.removeAllFilters(),this.url=null,this.isHosted=!1,this.valueProviderFactory=this.partsObj=this.expr=this.featureLayerId=this._layerDefinition=null)},isBuilding:function(){return this._def&&!this._def.isFulfilled()},build:function(a){var b=new h;this.isBuilding()?b.reject("Filter is already building."):(this._def=null,this.reset(),this.url=a.url,this.isHosted=w.isHostedService(this.url),
this._layerDefinition=a.layerDefinition,this.featureLayerId=a.featureLayerId,a.partsObj?(this.partsObj=this._updatePartsObj(a.partsObj),this._def=this._init("partsObj")):(this.expr=a.expr||"1\x3d1",this._def=this._init("expr")),b=this._def);return b},buildByExpr:function(a,b,c){console.warn("Filter#buildByExpr() method is deprecated, please use Filter#build() instead.");return this.build({url:a,expr:b,layerDefinition:c})},buildByFilterObj:function(a,b,c){console.warn("Filter#buildByFilterObj() method is deprecated, please use Filter#build() instead.");
return this.build({url:a,partsObj:b,layerDefinition:c})},_updatePartsObj:function(a){f.forEach(a,d.hitch(this,function(a){a.parts?f.forEach(a.parts,d.hitch(this,function(a){a.interactiveObj&&!0===a.interactiveObj.cascade?a.interactiveObj.cascade="previous":!1===a.interactiveObj.cascade&&(a.interactiveObj.cascade="none")})):a.interactiveObj&&!0===a.interactiveObj.cascade?a.interactiveObj.cascade="previous":!1===a.interactiveObj.cascade&&(a.interactiveObj.cascade="none")}));return a},removeAllFilters:function(){this._destroyAllFilters()},
_getLayerDefinitionRaw:function(a,b){var c=new h;b?c.resolve(b):(this.loading.show(),l({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(d.hitch(this,function(a){this.domNode?(this.loading.hide(),c.resolve(a)):c.reject()}),d.hitch(this,function(a){console.error(a);c.reject();this.domNode&&this.loading.hide()})));return c},_validateLayerDefinition:function(a){return this._isObject(a)},_init:function(a){var b=new h;if(!this._isString(this.url))return b.reject(),b;var c=d.hitch(this,
function(){setTimeout(d.hitch(this,function(){b.resolve()}),1500)}),m=d.hitch(this,function(){e.setStyle(this.contentSection,"display","block");e.setStyle(this.errorSection,"display","none");this.removeAllFilters();this.featureLayerId&&this._tryOverrideFieldAliases(this.featureLayerId,this._layerDefinition);var g=this._layerDefinition.fields;g&&0<g.length?(g=f.filter(g,d.hitch(this,function(a){return 0<=this._supportFieldTypes.indexOf(a.type)})))&&0<g.length?(this._validOptions=!0,e.removeClass(this.btnAddSet,
"jimu-state-disabled"),e.removeClass(this.btnAddExp,"jimu-state-disabled"),e.removeClass(this.iconAddExp,"jimu-state-disabled"),e.removeClass(this.iconAddSet,"jimu-state-disabled"),this.createFieldsStore(),this.valueProviderFactory=new y({url:this.url,layerDefinition:this._layerDefinition,featureLayerId:this.featureLayerId}),"expr"===a?this._isString(this.expr)?("1\x3d1"===this.expr.replace(/\s/gi,"")&&this.removeAllFilters(),this._parseExpr(this.expr)?c():b.reject()):b.reject():"partsObj"===a?this._validatePartsObj(this.partsObj)?
(this._parsePartsObj(this.partsObj),c()):b.reject():this._validatePartsObj(this.partsObj)?(this._parsePartsObj(this.partsObj),c()):this._isString(this.expr)?this._parseExpr(this.expr)?c():b.reject():(this.removeAllFilters(),c())):(this._showErrorOptions(this.nls.error.noFilterFields),b.reject()):b.reject()});this._validateLayerDefinition(this._layerDefinition)?m():(this.loading.show(),l({url:this.url,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(d.hitch(this,function(a){this.domNode?
(this.loading.hide(),this._layerDefinition=a,m()):b.reject()}),d.hitch(this,function(a){console.error(a);b.reject();this.domNode&&this.loading.hide()})));return b},_tryOverrideFieldAliases:function(a,b){var c=this.layerInfosObj.getLayerOrTableInfoById(a);if(c&&(c=c.getPopupInfo())){var c=c.fieldInfos,e=b.fields;if(c&&0<c.length&&e&&0<e.length){var g={};f.forEach(c,d.hitch(this,function(a){a.fieldName&&(g[a.fieldName]=a)}));f.forEach(e,d.hitch(this,function(a){var b=g[a.name];b&&b.label&&(a.alias=
b.label)}))}}},toJson:function(){var a={logicalOperator:this.allAnySelect.value,parts:[]},b=this._getAllSingleFiltersAndFilterSets();if(0===b.length)return a.expr="1\x3d1",a;f.forEach(b,d.hitch(this,function(b){b=b.toJson();a.parts.push(b)}));return f.every(a.parts,d.hitch(this,function(a){return!!a}))&&0<a.parts.length?(a.expr=this.getExprByFilterObj(a),a):null},createFieldsStore:function(){if(this._layerDefinition.fields&&0!==this._layerDefinition.fields.length){var a=d.clone(this._layerDefinition).fields;
0===this.setFieldsStoreByFieldInfos(a)&&this._showErrorOptions(this.nls.error.noFilterFields)}else this._showErrorOptions(this.nls.error.noFilterFields)},_parsePartsObj:function(a){this._validatePartsObj(a)&&(this.removeAllFilters(),this._buildEditUIByPartsObj(a))},_parseExpr:function(a){this._destroyAllFilters();var b=null;if(!this._validateLayerDefinition(this._layerDefinition))return b;if(!a||"string"!==typeof a)return this._showErrorOptions(this.nls.error.invalidSQL),b;if("1\x3d1"===this.expr.replace(/\s/gi,
""))return b={expr:"1\x3d1",parts:[],logicalOperator:"AND"};try{b=this.getFilterObjByExpr(a)}catch(c){b=null,console.error(c)}b?this._buildEditUIByPartsObj(b):this._showErrorOptions(this.nls.error.cantParseSQL);return b},_buildEditUIByPartsObj:function(a){a&&(this._destroyAllFilters(),this.allAnySelect.value=a.logicalOperator,f.forEach(a.parts,d.hitch(this,function(a){a.parts?this._addFilterSet(a):a.fieldObj&&a.operator&&a.valueObj&&this._addSingleFilter(a)})))},_addSingleFilter:function(a){a={url:this.url,
layerInfo:this._layerDefinition,stringFieldType:this._stringFieldType,dateFieldType:this._dateFieldType,numberFieldTypes:this._numberFieldTypes,part:a,OPERATORS:d.mixin({},this.OPERATORS),enableAskForValues:this.enableAskForValues,isHosted:this.isHosted,valueProviderFactory:this.valueProviderFactory};a=new A(a);a.placeAt(this.allExpsBox);a.startup();this.own(k.after(a,"_destroySelf",d.hitch(this,this._checkFilterNumbers)));this._checkFilterNumbers()},_addFilterSet:function(a){a={url:this.url,layerInfo:this._layerDefinition,
stringFieldType:this._stringFieldType,dateFieldType:this._dateFieldType,numberFieldTypes:this._numberFieldTypes,partsObj:a,OPERATORS:d.mixin({},this.OPERATORS),enableAskForValues:this.enableAskForValues,isHosted:this.isHosted,valueProviderFactory:this.valueProviderFactory};a=new B(a);a.placeAt(this.allExpsBox);a.startup();this.own(k.after(a,"_destroySelf",d.hitch(this,this._checkFilterNumbers)));this._checkFilterNumbers()},_destroyAllFilters:function(){for(var a=this._getAllSingleFiltersAndFilterSets();0<
a.length;)a[0].destroy(),a.splice(0,1);this._checkFilterNumbers()},_getAllSingleFiltersAndFilterSetsDoms:function(){var a=[];this.allExpsBox.childNodes&&0<this.allExpsBox.childNodes.length&&f.forEach(this.allExpsBox.childNodes,d.hitch(this,function(b){(e.hasClass(b,"jimu-single-filter")||e.hasClass(b,"jimu-filter-set"))&&a.push(b)}));return a},_getAllSingleFiltersAndFilterSets:function(){var a=this._getAllSingleFiltersAndFilterSetsDoms();return f.map(a,d.hitch(this,function(a){return z.byNode(a)}))},
_checkFilterNumbers:function(){var a=this._getAllSingleFiltersAndFilterSetsDoms();1<a.length?e.setStyle(this.matchMsg,"display","block"):e.setStyle(this.matchMsg,"display","none");0<a.length?e.setStyle(this.noFilterTipSection,"display","none"):e.setStyle(this.noFilterTipSection,"display","block");f.forEach(a,d.hitch(this,function(a,c){e.removeClass(a,"even-filter");e.removeClass(a,"odd-filter");e.addClass(a,0===(c+1)%2?"even-filter":"odd-filter")}));this.emit("filter-number-change")},_showErrorOptions:function(a){console.error(a);
e.setStyle(this.errorSection,"display","none");this.errorTip.innerHTML=a;this.loading.hide()},_onBtnAddSetClick:function(){this._layerDefinition&&this._validOptions&&this._addFilterSet()},_onBtnAddExpClick:function(){this._layerDefinition&&this._validOptions&&this._addSingleFilter()}})});